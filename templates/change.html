{% extends 'base.html' %}

{% block styles_top %}
<link rel="stylesheet" href="{{ url_for('static', filename='change.css') }}">
{% endblock %}

{% block content %}
{# Create a dictionary with categories and their respective friendly names. #}
{% set categories = {
    "additions": "New Addition",
    "major_version_changes": "Major Change",
    "minor_version_changes": "Minor Change",
    "other_version_changes": "Other Change",
    "patches": "Patch",
    "revocations": "Revocation",
    "deprecations": "Deprecation",
    "deletions": "Deletion"
} %}

<div class="row px-3">
    <div class="col-sm text-start">
        <a href="{{ url_for('upgrade', from_version=change.from_version, to_version=change.to_version) }}">‚Üê Go back to overview</a>
    </div>
    <div class="col-sm text-end">
        <p id="filter"></p>
    </div>
</div>


{# Store important data about the page in the following <div> with data-* attributes. #}
{# Several scripts need access to these informations. #}
<div id="data" class="center" data-page="change.html" data-from-version="{{ change.from_version }}" data-to-version="{{ change.to_version }}" data-url-status="{{ url_for('change_status') }}" data-url-classification="{{ url_for('change_classification') }}" data-url-links="{{ url_for('links') }}" data-id="mitre-link-{{ change.mitre_id | replace('.', '-') }}">
    <h1>{{ categories[change.change_category] }}</h1>
    <h2 class="center">
        <span id="mitre-id">{{ change.mitre_id }}</span>
        <br>
        <b>{{ change.technique }}</b>{% if change.sub_technique %}: {{ change.sub_technique }}{% endif %}
    </h2>
    <br>
    <a id="prev" href="" class="btn btn-secondary">Previous</a>
    <button id="diff-button" class="btn btn-primary">Show Diff</button>
    <a id="next" href="" class="btn btn-secondary">Next</a>
    <br><br>
    <table class="table table-bordered" style="width: 500px; margin: 0 auto;">
        <tr>
            <th>Client Criticality Sum</th>
            <th>Infrastructure Criticality Sum</th>
            <th>Service Criticality Sum</th>
        </tr>
        <tr>
            <td id="client-criticality-sum">{{ change.client_criticality_sum }}</td>
            <td id="infra-criticality-sum">{{ change.infra_criticality_sum }}</td>
            <td id="service-criticality-sum">{{ change.service_criticality_sum }}</td>
        </tr>
    </table>

    <br><br>
    <div class="container" style="width: 800px;">
        <div class="row">
            <div class="col">
                <h3>Classification:</h3>
                <div class="container" style="width: 500px; padding: 10px; text-align: left;">
                    <div class="row p-2">
                        <div class="col">
                            <label for="client-criticality">Client Criticality</label>
                            <br>
                            <input id="client-criticality" class="classification" type="number" min="0" max="3" value="{{ change.client_criticality }}">
                        </div>
                        <div class="col d-flex align-items-center">
                            <input id="confidentiality" type="checkbox" class="me-2 classification" {% if change.confidentiality %}checked{% endif %}>
                            <label for="confidentiality">Confidentiality</label>
                        </div>
                    </div>
                    <div class="row p-2">
                        <div class="col">
                            <label for="infra-criticality">Infrastructure Criticality</label>
                            <br>
                            <input id="infra-criticality" class="classification" type="number" min="0" max="3" value="{{ change.infra_criticality }}">
                        </div>
                        <div class="col d-flex align-items-center">
                            <input id="integrity" type="checkbox" class="me-2 classification" {% if change.integrity %}checked{% endif %}>
                            <label for="integrity">Integrity</label>
                        </div>
                    </div>
                    <div class="row p-2">
                        <div class="col">
                            <label for="service-criticality">Service Criticality</label>
                            <br>
                            <input id="service-criticality" class="classification" type="number" min="0" max="3" value="{{ change.service_criticality }}">
                        </div>
                        <div class="col d-flex align-items-center">
                            <input id="availability" type="checkbox" class="me-2 classification" {% if change.availability %}checked{% endif %}>
                            <label for="availability">Availability</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <h3>Status:</h3>
                <div>
                    <select class="status-select" style="vertical-align: middle; margin-right: 10px;" data-mitre-id="{{ change.mitre_id }}">
                        <option {% if change.status == 'Not Done' %} selected {% endif %}>Not Done</option>
                        <option {% if change.status == 'In Progress' %} selected {% endif %}>In Progress</option>
                        <option {% if change.status == 'Done' %} selected {% endif %}>Done</option>
                    </select>
                    {% set mitre_id = change.mitre_id | replace('.', '-') %}
                    {% set icon_class = "bi-check" if change.status == 'Done' else "bi-hourglass-split" if change.status == 'In Progress' else "bi-ban" %}
                    {% set color = "text-success" if change.status == 'Done' else "text-warning" if change.status == 'In Progress' else "text-danger" %}
                    <i id="icon-{{ mitre_id }}" class="bi {{ icon_class }} {{ color }} fs-3" style="vertical-align: middle;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container" style="white-space: wrap; padding-top: 75px;">
    {# Technique details and platforms #}
    <div class="row">
        <div class="col-sm">
            <h1>Technique</h1>
            <table class="table table-striped table-bordered table-hover">
                <tr>
                    <td><b>Tactic(s)</b></td>
                    <td>{{ change.tactics }}</td>
                </tr>
                <tr>
                    <td><b>Technique</b></td>
                    <td>{{ change.technique }}</td>
                </tr>
                <tr>
                    <td><b>Sub-Technique</b></td>
                    <td>{{ change.sub_technique or "-" }}</td>
                </tr>
            </table>
        </div>
        <div class="col-sm">
            <h1>Platforms</h1>
            <table class="table table-striped table-bordered table-hover">
                {% for p in platforms %}
                <tr>
                    <td>{{ p }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>
    <br><br>

    {# Descriptions #}
    <div class="row">
        {% if change.old_description %}
        <div class="col-sm">
            <h1>Old Description</h1>
            <div id="old-description">
                {{ change.old_description | markdown | safe }}
            </div>
        </div>
        <div class="col-sm">
            <h1>New Description</h1>
            <div id="new-description">
                {{ change.new_description | markdown | safe }}
            </div>
        </div>

        {% else %}
        <div class="col-sm">
            <h1>Description</h1>

            {% if change.change_category != "additions" %}
            <b><i>(Description is identical to previous version)</i></b>
            <br><br>
            {% endif %}

            <div id="new-description">
                {{ change.new_description | markdown | safe }}
            </div>
        </div>
        {% endif %}
    </div>
    <br><br>

    {# The following section covers any changes that are not the description. #}
    {% if other_changes %}
    <h1 data-bs-toggle="collapse" data-bs-target="#collapse" style="cursor: pointer;" aria-expanded="false">
        Other Changes
        <i class="bi bi-chevron-down toggle-icon fs-3"></i>
    </h1>
    
    {% if other_changes.get('values_changed') %}
    <br>
    <div id="collapse" class="collapse">
        <h4><b>Changes</b></h4>
        <table class="table table-striped table-bordored table-hover table-bordered">
            <thead>
                <tr>
                    <th style="width: 33%;">Change</th>
                    <th style="width: 33%;">Old Value</th>
                    <th style="width: 33%;">New Value</th>
                </tr>
            </thead>
            <tbody>
            {% for key, value in other_changes.values_changed.items() %}
            <tr>
                <td>{{ key }}</td>
                <td>{{ value.old_value }}</td>
                <td>{{ value.new_value }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% endif %}
    
        {% if other_changes.get('iterable_item_added') or other_changes.get('dictionary_item_added') %}
        <br>
        <h4><b>Additions</b></h4>
        <table class="table table-striped table-bordored table-hover table-bordered">
            <thead>
                <tr>
                    <th style="width: 33%;">Addition</th>
                    <th style="width: 66%;">Value</th>
                </tr>
            </thead>
            <tbody>
            {% if other_changes.get('iterable_item_added') %}
                {% for key, value in other_changes.iterable_item_added.items() %}
                <tr>
                    <td>{{ key }}</td>
                    <td>{{ value }}</td>
                </tr>
                {% endfor %}
            {% endif %}
    
            {% if other_changes.get('dictionary_item_added') %}
                {% for key, value in other_changes.dictionary_item_added.items() %}
                    <tr>
                        <td>{{ key }}</td>
                        <td>{{ value }}</td>
                    </tr>
                {% endfor %}
            {% endif %}
            </tbody>
        </table>
        {% endif %}
    
    
        {% if other_changes.get('iterable_item.removed') or other_changes.get('dictionary_item_removed') %}
        <br>
        <h4><b>Removals</b></h4>
        <table class="table table-striped table-bordored table-hover table-bordered">
            <thead>
                <tr>
                    <th style="width: 33%;">Removal</th>
                    <th style="width: 66%;">Value</th>
                </tr>
            </thead>
            <tbody>
            {% if other_changes.get('iterable_item_removed') %}
                {% for key, value in other_changes.iterable_item_removed.items() %}
                    <tr>
                        <td>{{ key }}</td>
                        <td>{{ value }}</td>
                    </tr>
                {% endfor %}
            {% endif %}
    
            {% if other_changes.get('dictionary_item_removed') %}
                {% for key, value in other_changes.dictionary_item_removed.items() %}
                    <tr>
                        <td>{{ key }}</td>
                        <td>{{ value }}</td>
                    </tr>
                {% endfor %}
            {% endif %}
            </tbody>
        </table>
        {% endif %}

        {% if other_changes.get("changelog_mitigations").get("new") or other_changes.get("changelog_mitigations").get("dropped") %}
        <br>
        <h4><b>Mitigations</b></h4>
            <table class="table table-striped table-bordored table-hover table-bordered">
            {% if other_changes.get("changelog_mitigations").get("new") %}
                {% for c in other_changes.changelog_mitigations.new %}
                    <tr>
                        <td style="width: 10%;">Added</td>
                        <td style="width: 90%;">{{ c }}</td>
                    </tr>
                {% endfor %}
            {% endif %}

            {% if other_changes.get("changelog_mitigations").get("dropped") %}
                {% for c in other_changes.changelog_mitigations.dropped %}
                    <tr>
                        <td style="width: 10%;">Added</td>
                        <td style="width: 90%;">{{ c }}</td>
                    </tr>
                {% endfor %}
            {% endif %}
            </table>
        {% endif %}

        {% if other_changes.get("changelog_detections").get("new") or other_changes.get("changelog_detections").get("dropped") %}
        <br>
        <h4><b>Detections</b></h4>
            <table class="table table-striped table-bordored table-hover table-bordered">
            {% if other_changes.get("changelog_detections").get("new") %}
                {% for c in other_changes.changelog_detections.new %}
                    <tr>
                        <td style="width: 10%;">Added</td>
                        <td style="width: 90%;">{{ c }}</td>
                    </tr>
                {% endfor %}
                </ul>
            {% endif %}

            {% if other_changes.get("changelog_detections").get("dropped") %}
            <ul>
                {% for c in other_changes.changelog_detections.dropped %}
                    <tr>
                        <td style="width: 10%;">Removed</td>
                        <td style="width: 90%;">{{ c }}</td>
                    </tr>
                {% endfor %}
            </ul>
            {% endif %}
            </table>
        {% endif %}

        {% if other_changes.get("changelog_detection_strategies").get("new") or other_changes.get("changelog_detection_strategies").get("dropped") %}
        <br>
        <h4><b>Detection Strategies</b></h4>
            <table class="table table-striped table-bordored table-hover table-bordered">
            {% if other_changes.get("changelog_detection_strategies").get("new") %}
                {% for c in other_changes.changelog_detection_strategies.new %}
                    <tr>
                        <td style="width: 10%;">Added</td>
                        <td style="width: 90%;">{{ c }}</td>
                        
                    </tr>

                {% endfor %}
            {% endif %}

            {% if other_changes.get("changelog_detection_strategies").get("dropped") %}
                {% for c in other_changes.changelog_detection_strategies.dropped %}
                    <tr>
                        <td style="width: 10%;">Removed</td>
                        <td style="width: 90%;">{{ c }}</td>
                    </tr>
                {% endfor %}
            {% endif %}
            </table>
        {% endif %}
        <br><br>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts_bottom %}
<script src="{{ url_for('static', filename='change.js') }}"></script>
<script src="{{ url_for('static', filename='status.js') }}"></script>
<script src="{{ url_for('static', filename='scroll_position.js')}}"></script>
{% endblock %}
{% extends 'base.html' %}

{# Create a list with categories and their respective friendly names. #}
{% set categories = [
        ("additions", "New Additions"),
        ("major_version_changes", "Major Changes"),
        ("minor_version_changes", "Minor Changes"),
        ("other_version_changes", "Other Changes"),
        ("patches", "Patches"),
        ("revocations", "Revocations"),
        ("deprecations", "Deprecations"),
        ("deletions", "Deletions")
] %}

{# Calculate the total progress #}
{% set items_count = changes | count %}
{% set done_count = changes | selectattr("status", "equalto", "Done") | list | count %}
{% set percentage = (done_count / items_count * 100) | round(2) %}

{% block content %}
<div id="data" style="overflow: auto;" data-from-version="{{ from_version }}" data-to-version="{{ to_version }}" data-url-status="{{ url_for('change_status') }}">
    <div style="float: left;">
        <h1 id="status-total">Progress: {{ percentage }}%</h1>
        <h3>{{ from_version }} to {{ to_version }}</h3>
        <br>
        <label for="file">Upload Spreadsheet File (In Progress):</label>
        <br>
        <input id="file" type="file">
    </div>

    <div style="float: right;">
        <h1>Filter:</h1>
        <div class="btn-group" role="group">
            <input type="radio" class="btn-check" name="btnradio" id="btnradio1" checked>
            <label class="btn btn-outline-primary" for="btnradio1">All</label>

            <input type="radio" class="btn-check" name="btnradio" id="btnradio2">
            <label class="btn btn-outline-primary" for="btnradio2">Done</label>

            <input type="radio" class="btn-check" name="btnradio" id="btnradio3">
            <label class="btn btn-outline-primary" for="btnradio3">In Progress</label>

            <input type="radio" class="btn-check" name="btnradio" id="btnradio4">
            <label class="btn btn-outline-primary" for="btnradio4">Not Done</label>
        </div>
    </div>
</div>
<br>

{% for key, title in categories %}
    {% set items = changes | selectattr("change_category", "equalto", key) | list %}
    {% if items | count != 0 %}

        {# Calculate the progress for the current category. #}
        {% set items_count = items | count %}  
        {% set done_count = items | selectattr("status", "equalto", "Done") | list | count %}
        {% set percentage = (done_count / items_count * 100) | round(2) %}
        
        <h2>{{ title }} ({{ items_count }})</h2>
        <h4 id="status-{{ key }}">Progress: {{ percentage }}%</h4>

        <table class="table table-striped table-bordered table-hover">
            <thead>
                <tr style="vertical-align: middle;">
                    <th style="width: 10%;">MITRE ID</th>
                    <th style="width: 20%;">Category</th>
                    <th style="width: 20%;">Sub-Category</th>
                    <th style="width: 30%;">Technique</th>
                    <th style="width: 5%;">Client Criticality Sum</th>
                    <th style="width: 5%;">Infrastructure Criticality Sum</th>
                    <th style="width: 5%;">Service Criticality Sum</th>
                    <th style="width: 15%;">Status</th>
                    <th style="width: 10%;">Icon</th>
                </tr>
            </thead>
            <tbody style="vertical-align: middle;">
            {% for i in items %}
                <tr>
                    {# Replace "." with "-" in IDs or else it could cause problems with CSS selectors. #}
                    <td><a id="mitre-link-{{ i.mitre_id | replace('.', '-') }}" class="mitre-link" href="{{ url_for('change', from_version=from_version, to_version=to_version, category=i.category, mitre_id=i.mitre_id) }}">{{ i.mitre_id }}</a></td>
                    {# Transform the category string (e.g. 'privilege-escalation' -> 'Privilege Escalation') #}
                    <td>{{ i.category.replace('-', ' ').title() }}</td>
                    <td>{{ i.sub_category }}</td>
                    {# If 'i.technique' is empty, use '-'. #}
                    <td>{{ i.technique or "âˆ’" }}</td>
                    <td>{{ i.client_criticality_sum }}</td>
                    <td>{{ i.infra_criticality_sum }}</td>
                    <td>{{ i.service_criticality_sum }}</td>
                    <td>
                        {# Use data attributes, so when updated, we know exactly which one is updates in JS. #}
                        <select class="status-select" data-mitre-id="{{ i.mitre_id }}" data-category="{{ i.category }}" data-change-category="{{ key }}">
                            <option {% if i.status == 'Not Done' %} selected {% endif %}>Not Done</option>
                            <option {% if i.status == 'In Progress' %} selected {% endif %}>In Progress</option>
                            <option {% if i.status == 'Done' %} selected {% endif %}>Done</option>
                        </select>
                    </td>
                    <td>
                        {# Dots are invalid in IDs. #}
                        {% set mitre_id = i.mitre_id | replace('.', '-') %}
                        {% set icon_class = "bi-check" if i.status == 'Done' else "bi-hourglass-split" if i.status == 'In Progress' else "bi-ban" %}
                        {% set color = "text-success" if i.status == 'Done' else "text-warning" if i.status == 'In Progress' else "text-danger" %}
                        <i id="icon-{{ mitre_id }}" class="bi {{ icon_class }} {{ color }} fs-4"></i>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% endif %}
{% endfor %}
{% endblock %}

{% block scripts_bottom %}
<script src="{{ url_for('static', filename='scroll_position.js') }}"></script>
<script src="{{ url_for('static', filename='filter.js') }}"></script>
<script src="{{ url_for('static', filename='status.js') }}"></script>
{% endblock %}